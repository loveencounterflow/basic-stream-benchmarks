// Generated by CoffeeScript 1.11.1
(function() {
  var $as_line, $show, $split, CND, FS, O, PATH, V8PROFILER, badge, debug, format_float, format_integer, help, info, new_numeral, rpr, running_in_devtools, start_profile, step, stop_profile, through2, warn, whisper;

  CND = require('cnd');

  rpr = CND.rpr;

  badge = 'BASIC-STREAM-BENCHMARKS';

  debug = CND.get_logger('debug', badge);

  warn = CND.get_logger('warn', badge);

  info = CND.get_logger('info', badge);

  help = CND.get_logger('help', badge);

  whisper = CND.get_logger('whisper', badge);

  PATH = require('path');

  FS = require('fs');

  through2 = require('through2');

  $split = require('binary-split');

  new_numeral = require('numeral');

  format_float = function(x) {
    return (new_numeral(x)).format('0,0.000');
  };

  format_integer = function(x) {
    return (new_numeral(x)).format('0,0');
  };

  step = require('coffeenode-suspend').step;

  O = {};

  O.inputs = {};

  O.inputs['long'] = PATH.resolve(__dirname, '../test-data/Unicode-NamesList.txt');

  O.inputs['short'] = PATH.resolve(__dirname, '../test-data/Unicode-NamesList-short.txt');


  /* Avoid to try (and, presumably, fail due to v8 version mismatch) to require `v8-profiler` when running
  this module with `devtool`:
   */

  V8PROFILER = null;

  $show = function() {
    return through2(function(data, encoding, callback) {
      this.push(data);
      return callback();
    });
  };

  $as_line = function() {
    return through2(function(data, encoding, callback) {
      this.push(data + '\n');
      return callback();
    });
  };

  this.report = function(S) {
    var bps, bps_txt, byte_count_txt, dts, dts_txt, ips, ips_txt, item_count_txt;
    dts = (S.t1 - S.t0) / 1000;
    bps = S.byte_count / dts;
    ips = S.item_count / dts;
    byte_count_txt = format_integer(S.byte_count);
    item_count_txt = format_integer(S.item_count);
    dts_txt = format_float(dts);
    bps_txt = format_float(bps);
    ips_txt = format_float(ips);
    help(dts_txt + "s");
    help(byte_count_txt + " bytes / " + item_count_txt + " items");
    return help(bps_txt + " bps / " + ips_txt + " ips");
  };

  running_in_devtools = console.profile != null;

  start_profile = function(name) {
    if (running_in_devtools) {
      return console.profile(name);
    } else {
      V8PROFILER = require('v8-profiler');
      return V8PROFILER.startProfiling(name);
    }
  };

  stop_profile = function(name) {
    var profile;
    if (running_in_devtools) {
      return console.profileEnd(name);
    } else {
      profile = V8PROFILER.stopProfiling(name);
      return profile["export"]((function(_this) {
        return function(error, result) {
          if (error != null) {
            throw error;
          }
          return FS.writeFileSync("profile-" + name + ".json", result);
        };
      })(this));
    }
  };

  this.read_with_transforms = function(n, input_name, mode, handler) {
    var S, _, i, input, input_path, name, output, output_path, p, ref;
    input_path = O.inputs[input_name];
    if (input_path == null) {
      throw new Error("unknown input name " + (rpr(input_name)));
    }
    if (mode !== 'sync' && mode !== 'async') {
      throw new Error("unknown mode " + (rpr(mode)));
    }
    output_path = '/dev/null';
    input = FS.createReadStream(input_path);
    output = FS.createWriteStream(output_path);
    S = {};
    S.byte_count = 0;
    S.item_count = 0;
    S.t0 = null;
    S.t1 = null;
    name = "n:" + n;
    p = input;
    p = p.pipe($split());
    p = p.pipe(through2.obj(function(data, encoding, callback) {
      if (S.t0 == null) {
        start_profile(name);
        if (S.t0 == null) {
          S.t0 = Date.now();
        }
      }
      S.byte_count += data.length;
      S.item_count += +1;
      this.push(data);
      return callback();
    }));
    for (_ = i = 1, ref = n; i <= ref; _ = i += +1) {
      if (mode === 'sync') {
        p = p.pipe(through2.obj(function(data, encoding, callback) {
          this.push(data);
          return callback();
        }));
      } else {
        p = p.pipe(through2.obj(function(data, encoding, callback) {
          return setImmediate((function(_this) {
            return function() {
              _this.push(data);
              return callback();
            };
          })(this));
        }));
      }
    }
    p = p.pipe($as_line());
    p = p.pipe(output);
    output.on('close', (function(_this) {
      return function() {
        stop_profile(name);
        S.t1 = Date.now();
        _this.report(S);
        return handler();
      };
    })(this));
    return null;
  };

  this.main = function() {
    var input_name, mode;
    input_name = 'short';
    mode = 'async';
    return step((function(_this) {
      return function*(resume) {
        var i, run;
        for (run = i = 1; i <= 1; run = ++i) {
          yield _this.read_with_transforms(5, input_name, mode, resume);
        }
        if (running_in_devtools) {
          return setTimeout((function() {
            return help('ok');
          }), 1e6);
        }
      };
    })(this));
  };

  if (module.parent == null) {
    this.main();
  }

}).call(this);

//# sourceMappingURL=main.js.map
